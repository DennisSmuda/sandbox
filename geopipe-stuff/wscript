import os
import sys
sys.path = [os.path.abspath("./scripts/waf_utils")] + sys.path

import waf_commands

APPNAME = "geopipe-stuff"
from waflib import Logs


def options(opt):
    opt.load("compiler_c")
    opt.load("compiler_cxx")
    opt.load("waf_default", tooldir="./scripts/waf_utils")


def configure(conf):
    conf.load("compiler_c")
    conf.load("compiler_cxx")
    conf.load("waf_default", tooldir="./scripts/waf_utils")

    src_dir = conf.srcnode.abspath()
    deps_dir = os.path.join(src_dir, "deps")
    deps_install_dir = os.path.join(deps_dir, "_install")
    deps_install_include_dir = os.path.join(deps_install_dir, "include")
    deps_install_lib_dir = os.path.join(deps_install_dir, "lib")

    conf.env.append_value("CXXFLAGS", ["-isystem", deps_dir])
    conf.env.append_value("CXXFLAGS", ["-isystem", deps_install_include_dir])
    conf.env.append_value("LINKFLAGS", ["-L", deps_install_lib_dir])

    conf.env.LIB_LASLIB = "las"
    conf.env.LIB_GFLAGS = "gflags"


def build(bld):
    if bld.cmd == "build":
        waf_commands.MakefileGen().execute()

    bld.stlib(source=bld.path.ant_glob("deps/gtest/*.cc"),
              target="gtest_main")

    bld.program(source=bld.path.ant_glob("test/test-*.cc"),
                target="t",
                use="gtest_main LASLIB")

    bld.program(source=bld.path.ant_glob("las2img/*.cc"),
                target="las2img.bin",
                use="LASLIB GFLAGS")
